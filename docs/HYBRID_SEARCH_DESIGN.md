# üèóÔ∏è –ü—Ä–æ–µ–∫—Ç –ì–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ü–æ–∏—Å–∫–æ–≤–æ–≥–æ –î–≤–∏–∂–∫–∞

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
HybridSearchEngine
‚îú‚îÄ‚îÄ QueryAnalyzer          # –ê–Ω–∞–ª–∏–∑ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ Intent Detection   # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ Keyword Extraction # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ Query Expansion    # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
‚îÇ
‚îú‚îÄ‚îÄ MultiStageRetriever    # –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ BM25 Stage        # –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ (500 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ Semantic Stage    # –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (100 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)
‚îÇ   ‚îî‚îÄ‚îÄ Candidate Merge   # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ ScoringEngine          # –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –æ—á–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ BM25Score         # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π BM25
‚îÇ   ‚îú‚îÄ‚îÄ SemanticScore      # –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
‚îÇ   ‚îú‚îÄ‚îÄ KeywordDensity    # –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ ExactMatch        # –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ContextBoost      # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ ProximityBonus    # –ë–æ–Ω—É—Å –∑–∞ –±–ª–∏–∑–æ—Å—Ç—å —Å–ª–æ–≤
‚îÇ
‚îî‚îÄ‚îÄ EnsembleRanker         # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
    ‚îú‚îÄ‚îÄ Weight Tuning     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ—Å–æ–≤
    ‚îú‚îÄ‚îÄ Score Fusion      # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ–≤
    ‚îî‚îÄ‚îÄ Final Ranking     # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞

### Stage 1: Query Understanding (–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞)
```
–í—Ö–æ–¥: "–ø–æ–∫–∞–∂–∏ –Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –∂–∞–ª–æ–≤–∞–ª–∏—Å—å –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"

–®–∞–≥–∏:
1. Intent Detection:
   - –¢–∏–ø: "–ø–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º"
   - –°—É—â–Ω–æ—Å—Ç–∏: ["–∫–ª–∏–µ–Ω—Ç", "–æ–ø–µ—Ä–∞—Ç–æ—Ä"]
   - –≠–º–æ—Ü–∏–∏: ["–Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ", "–∂–∞–ª–æ–±–∞"]

2. Keyword Extraction:
   - –û—Å–Ω–æ–≤–Ω—ã–µ: ["–Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã–π", "–∫–ª–∏–µ–Ω—Ç", "–∂–∞–ª–æ–≤–∞–ª—Å—è", "–æ–ø–µ—Ä–∞—Ç–æ—Ä"]
   - –°–∏–Ω–æ–Ω–∏–º—ã: ["–Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ", "–∂–∞–ª–æ–±–∞", "–ø—Ä–æ–±–ª–µ–º–∞", "–º–µ–Ω–µ–¥–∂–µ—Ä"]

3. Query Expansion:
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π: "–Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∂–∞–ª—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–±–ª–µ–º–∞"
   - –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏: ["–∂–∞–ª–æ–±–∞", "–Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ", "–ø—Ä–æ–±–ª–µ–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è"]
```

### Stage 2: Multi-Stage Retrieval (–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞)
```
2a. BM25 Search (–±—ã—Å—Ç—Ä—ã–π, 500 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤):
   - Elasticsearch multi_match –∑–∞–ø—Ä–æ—Å
   - –ü–æ–ª—è: text_full^3, text_clean_full^2, text_summary^1
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å BM25 score

2b. Semantic Search (100 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤):
   - E5-large embeddings –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
   - –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å semantic score

2c. Candidate Merge:
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ call_id
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫: ~400-600 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
```

### Stage 3: Multi-Factor Scoring (–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç)
```
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:

1. BM25 Score (0.30):
   - –ë–∞–∑–æ–≤—ã–π Elasticsearch BM25 score
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: score / max_score

2. Semantic Score (0.25):
   - –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ embeddings
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: cosine_sim * 10

3. Keyword Density (0.25):
   - TF –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞
   - –ë–æ–Ω—É—Å –∑–∞ –±–ª–∏–∑–æ—Å—Ç—å —Å–ª–æ–≤
   - –ë–æ–Ω—É—Å –∑–∞ –ø–æ–∑–∏—Ü–∏—é (–Ω–∞—á–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
   - –§–æ—Ä–º—É–ª–∞: Œ£(TF(word) * proximity * position_bonus) / len(query_words)

4. Exact Match Bonus (0.15):
   - –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ—Ä–∞–∑—ã: +10.0
   - –í—Å–µ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞: +5.0
   - –ß–∞—Å—Ç–∏—á–Ω–æ–µ: +2.0

5. Context Boost (0.08):
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ intent –∏ metadata
   - –ü—Ä–∏–º–µ—Ä—ã:
     * "–≤—Ö–æ–¥—è—â–∏–µ" + call_type="–í—Ö–æ–¥—è—â–∏–π": x5.0
     * "–Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ" + problem_call=True: x4.0
     * "–æ–ø–µ—Ä–∞—Ç–æ—Ä" + operator_name match: x3.0

6. Proximity Bonus (0.05):
   - –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ –∑–∞–ø—Ä–æ—Å–∞
   - –ë–ª–∏–∑–∫–æ (< 5 —Å–ª–æ–≤): +3.0
   - –°—Ä–µ–¥–Ω–µ (5-10 —Å–ª–æ–≤): +1.5
   - –î–∞–ª–µ–∫–æ (> 10 —Å–ª–æ–≤): +0.5

7. Field Boost (0.02):
   - –ü–æ–∑–∏—Ü–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
   - text_summary: x2.0
   - text_full –Ω–∞—á–∞–ª–æ: x1.5
   - text_full —Å–µ—Ä–µ–¥–∏–Ω–∞: x1.0
```

### Stage 4: Ensemble Ranking (–ê–Ω—Å–∞–º–±–ª–µ–≤–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ)
```
–§–æ—Ä–º—É–ª–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫–æ—Ä–∞:

final_score = 
    bm25_score * 0.30 +
    semantic_score * 0.25 +
    keyword_density * 0.25 +
    exact_match * 0.15 +
    context_boost * 0.08 +
    proximity_bonus * 0.05 +
    field_boost * 0.02

–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ final_score DESC
–í–æ–∑–≤—Ä–∞—Ç —Ç–æ–ø-N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ | BM25 —Ç–æ–ª—å–∫–æ | Semantic —Ç–æ–ª—å–∫–æ | –ì–∏–±—Ä–∏–¥–Ω—ã–π |
|------------|-------------|-----------------|-----------|
| –¢–æ—á–Ω—ã–π ("–≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏") | 95% | 85% | **98%** |
| –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π ("–Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç") | 60% | 75% | **90%** |
| –ö–æ—Å–≤–µ–Ω–Ω—ã–π ("–∂–∞–ª–æ–±—ã –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞") | 40% | 70% | **88%** |
| –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ | 50% | 75% | **85%** |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ—Å–æ–≤

–í–µ—Å–∞ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ:

```python
weights = {
    'bm25': 0.30,          # –î–ª—è —Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    'semantic': 0.25,      # –î–ª—è –∫–æ—Å–≤–µ–Ω–Ω—ã—Ö
    'keyword_density': 0.25, # –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
    'exact_match': 0.15,    # –î–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    'context_boost': 0.08,  # –î–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    'proximity_bonus': 0.05, # –î–ª—è –±–ª–∏–∑–æ—Å—Ç–∏ —Å–ª–æ–≤
    'field_boost': 0.02      # –î–ª—è –ø–æ–∑–∏—Ü–∏–∏
}
```

## üöÄ –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã HybridSearchEngine
2. ‚úÖ QueryAnalyzer - –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚úÖ MultiStageRetriever - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞
4. ‚úÖ KeywordDensityScoring - –ø–æ–¥—Å—á–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
5. ‚úÖ ContextBoost - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ
6. ‚úÖ EnsembleRanker - —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
7. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ API
8. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

